(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class gt{constructor(){this.channels={}}on(t,e){this.channels[t]||(this.channels[t]=[]),this.channels[t].push(e)}off(t,e){if(this.channels[t]){const n=this.channels[t].indexOf(e);n>-1&&this.channels[t].splice(n,1)}}emit(t,e){const n=this.channels[t];!n||!n.length||n.forEach(i=>i(e))}}const y=new gt;function P(s,t){return Math.atan2(t.y-s.y,t.x-s.x)}function ut(s,t,e){var n,i,o=e===void 0?2166136261:e;for(n=0,i=s.length;n<i;n++)o^=s.charCodeAt(n),o+=(o<<1)+(o<<4)+(o<<7)+(o<<8)+(o<<24);return("0000000"+(o>>>0).toString(16)).substr(-8)}function ft(s){let t=Date.now().toString().slice(9,12);return ut(s,!0,t)}function yt(){let s=1;return()=>s++}const p=yt();class g{constructor(t,e,n){this.id=n||0,this.x=t,this.y=e,typeof t=="object"?(this.x=t.x||0,this.y=t.y||0):(e===void 0&&(e=t),this.x=t||0,this.y=e||0)}set(t,e){return e===void 0&&(e=t),this.x=t,this.y=e,this}copy(){return new g(this.x,this.y)}add(t){return this.x+=t.x,this.y+=t.y,this}rotateAround(t){const e=Math.cos(t),n=Math.sin(t),i=this.x,o=this.y;return this.x=i*e-o*n,this.y=i*n+o*e,this}}const x={START_SKETCH:"start-sketch",STOP_SKETCH:"stop-sketch",FINISHED_DRAW_SHAPE:"fineshd-draw-shape",REDRAW_CANVAS:"redraw-canvas",CREATE_ROOM:"create-room",SET_THICKNESS:"set-thickness",SET_READY:"set-ready"};class mt{constructor(){this.canvas=document.getElementById("canvas"),this.canvas.width=window.clientX,this.canvas.height=window.clientY,this.canvasBoundingRect=this.canvas.getBoundingClientRect(),this.canvas.width=this.canvasBoundingRect.width,this.canvas.height=this.canvasBoundingRect.height,this.ctx=this.canvas.getContext("2d"),y.on(x.REDRAW_CANVAS,this.redraw.bind(this)),this.renderList=[]}getPointerPos(t){const{x:e,y:n}=this.canvasBoundingRect;return{x:t.clientX-e,y:t.clientY-n}}add(t){this.renderList.push(t)}remove(t){const e=this.renderList.indexOf(t);e!==-1&&this.renderList.splice(e,1)}clear(){this.ctx.clearRect(0,0,this.canvasBoundingRect.width,this.canvasBoundingRect.height)}redraw(){this.clear(),this.renderList.forEach(t=>{t.draw(this.ctx)})}}const X={CREATE_WALL:"create-wall"};class xt{constructor(){this.button=document.getElementById("button"),this.button.addEventListener("click",()=>{y.emit(X.CREATE_WALL)})}}function wt(){let s=!1;const t=document.getElementById("edit"),e=document.getElementsByClassName("edit-container")[0],n=document.createElement("div");n.setAttribute("class","dialog"),e.appendChild(n);const i=document.createElement("div");i.setAttribute("class","place-input"),n.appendChild(i);const o=document.createElement("input");o.setAttribute("class","form-control"),o.setAttribute("placeholder",10),o.value=10,i.appendChild(o);const r=document.createElement("div");r.setAttribute("class","place-input-buttons"),i.appendChild(r);const l=document.createElement("button");l.innerHTML="ok",l.setAttribute("class","checkout-button"),n.appendChild(l),l.addEventListener("click",()=>{}),n.style.display="none",t.addEventListener("click",()=>{s?(n.style.display="none",s=!1):(n.style.display="block",s=!0)}),l.addEventListener("click",()=>{s&&(n.style.display="none",s=!1,y.emit(x.SET_THICKNESS,o.value))})}class Pt{constructor(t,e){this.id=t,this.name=e,this.rooms=[]}}class pt{constructor(t){this.name=t,this.points=[],this.walls=[],this.ready=!1,this.thickness=10,this.outPolygon=null,this.innerPolygon=null}}function K(){const s=document.createElement("canvas"),t=s.getContext("2d");return s.width=20,s.height=20,t.fillStyle="#f7f7f7",t.fillRect(0,0,s.width,s.height),t.moveTo(5,0),t.lineTo(0,5),t.moveTo(20,5),t.lineTo(5,20),t.strokeStyle="#777",t.stroke(),s}class Et{constructor(t){this.data=t,this.pattern=K()}draw(t){this.data.ready?this.drawWalls(t):this.drawAxis(t,this.data.points)}drawWalls(t){t.strokeStyle="black";const e=new Path2D;this.drawPolygon(e,this.data.outPolygon),this.drawPolygon(e,this.data.innerPolygon),t.stroke(e);const n=t.createPattern(this.pattern,"repeat");t.fillStyle=n,t.fill(e,"evenodd"),this.fillPolygon(t,this.data.innerPolygon),this.drawAxisPoint(t)}drawAxisPoint(t){t.fillStyle="darkgray";for(let e=0;e<this.data.points.length;e++){let n=this.data.points[e];t.beginPath(),t.arc(n.x,n.y,4,0,Math.PI*2,!0),t.fill()}}drawAxis(t,e){if(e.length===0)return;t.strokeStyle="black",t.beginPath();const n=e[0];t.moveTo(n.x,n.y),t.arc(n.x,n.y,3,0,Math.PI*2,!0);for(let i=1;i<e.length;i++){let o=e[i];t.lineTo(o.x,o.y),t.arc(o.x,o.y,3,0,Math.PI*2,!0)}t.stroke()}drawPolygon(t,e){if(e.length===0)return;const n=e[0];t.moveTo(n.x,n.y);for(let i=1;i<e.length;i++){let o=e[i];t.lineTo(o.x,o.y)}t.closePath()}fillPolygon(t,e){if(e.length===0)return;const n=e[0];t.fillStyle="white",t.moveTo(n.x,n.y);for(let i=1;i<e.length;i++){let o=e[i];t.lineTo(o.x,o.y)}t.closePath(),t.fill()}}const C=Math.PI*2;function H(s,t){const e=t.x-s.x,n=t.y-s.y,i=Math.sqrt(e*e+n*n);return{x:-n/i,y:e/i}}function vt(s,t){var e=H(s,t);return{x:-e.x,y:-e.y}}function F(s){const t=[];let e=s.length>0?s[0].x:void 0,n=s.length>0?s[0].y:void 0,i=e,o=n;for(let l=0;l<s.length;l++){const a=s[l],h=s[(l+1)%s.length],c=vt(a,h),d=H(a,h),f={vertex1:a,vertex2:h,index:l,outwardNormal:c,inwardNormal:d};t.push(f);const w=s[l].x,Y=s[l].y;e=Math.min(w,e),n=Math.min(Y,n),i=Math.max(w,i),o=Math.max(Y,o)}return{vertices:s,edges:t,minX:e,minY:n,maxX:i,maxY:o}}function Z(s,t){const e=(t.vertex2.y-t.vertex1.y)*(s.vertex2.x-s.vertex1.x)-(t.vertex2.x-t.vertex1.x)*(s.vertex2.y-s.vertex1.y);if(e==0)return null;const n=((t.vertex2.x-t.vertex1.x)*(s.vertex1.y-t.vertex1.y)-(t.vertex2.y-t.vertex1.y)*(s.vertex1.x-t.vertex1.x))/e,i=((s.vertex2.x-s.vertex1.x)*(s.vertex1.y-t.vertex1.y)-(s.vertex2.y-s.vertex1.y)*(s.vertex1.x-t.vertex1.x))/e,o=n<0||i<0||n>1||i>1;return{x:s.vertex1.x+n*(s.vertex2.x-s.vertex1.x),y:s.vertex1.y+n*(s.vertex2.y-s.vertex1.y),isIntersectionOutside:o}}function G(s,t,e,n,i,o,r){var l=Math.atan2(i.y-e.y,i.x-e.x),a=Math.atan2(o.y-e.y,o.x-e.x);l<0&&(l+=C),a<0&&(a+=C);const h=l>a?l-a:l+C-a,c=(r?-h:C-h)/s;t.push(i);for(let d=1;d<s;++d){const f=l+c*d,w={x:e.x+Math.cos(f)*n,y:e.y+Math.sin(f)*n};t.push(w)}t.push(o)}function _(s,t,e){return{vertex1:{x:s.vertex1.x+t,y:s.vertex1.y+e},vertex2:{x:s.vertex2.x+t,y:s.vertex2.y+e}}}function At(s,t,e){const n=[];for(let r=0;r<s.edges.length;r++){const l=s.edges[r],a=l.outwardNormal.x*t,h=l.outwardNormal.y*t;n.push(_(l,a,h))}const i=[];for(let r=0;r<n.length;r++){const l=n[r],a=n[(r+n.length-1)%n.length],h=Z(a,l);if(h&&(!h.isIntersectionOutside||e<1))i.push(new g(h.x,h.y));else{const c=s.edges[r].vertex1;G(e,i,c,t,a.vertex2,l.vertex1,!1)}}const o=F(i);return o.offsetEdges=n,o}function Mt(s,t,e){const n=[];for(let r=0;r<s.edges.length;r++){const l=s.edges[r],a=l.inwardNormal.x*t,h=l.inwardNormal.y*t;n.push(_(l,a,h))}const i=[];for(let r=0;r<n.length;r++){const l=n[r],a=n[(r+n.length-1)%n.length],h=Z(a,l);if(h&&(!h.isIntersectionOutside||e<1))i.push(new g(h.x,h.y));else{const c=s.edges[r].vertex1;G(e,i,c,t,a.vertex2,l.vertex1,!0)}}const o=F(i);return o.offsetEdges=n,o}function R(s,t,e=0){const n=F(s);return t>0?At(n,t,e).vertices:Mt(n,-t,e).vertices}class ${constructor(){this.id=ft("wall"),this.axis=[],this.childs=[],this.polygon=[],this.thiсkness=20}}var Lt={};const m={set:s=>{const t=document.getElementsByTagName("body")[0];t.style.cursor=`url('${Lt.PUBLIC_URL}/assets/img/${s}'),auto`},auto:()=>{const s=document.getElementsByTagName("body")[0];s.style.cursor="auto"},move:()=>{const s=document.getElementsByTagName("body")[0];s.style.cursor="move"},pointer:()=>{const s=document.getElementsByTagName("body")[0];s.style.cursor="pointer"},none:()=>{const s=document.getElementsByTagName("body")[0];s.style.cursor="none"}};function A(s,t){var e=s.x-t.x,n=s.y-t.y;return Math.sqrt(e*e+n*n)}function Wt(s,t){const e=t.x-s.x,n=t.y-s.y;return new g(-n,e)}function T(s,t){const e=t.length;let n=!1,i=0;for(let o=0;o<e;o++){const r=t[o],l=t[(o+1)%e];s.y>Math.min(r.y,l.y)&&s.y<=Math.max(r.y,l.y)&&s.x<=Math.max(r.x,l.x)&&(r.y!==l.y&&(i=(s.y-r.y)*(l.x-r.x)/(l.y-r.y)+r.x),(r.x===l.x||s.x<=i)&&(n=!n))}return n}function tt(s){const t=s.reduce((l,a,h)=>s[l].x>a.x?h:l,0),e=St(t,s.length-1),n={x:s[e.middleIndex].x-s[e.beginIndex].x,y:s[e.middleIndex].y-s[e.beginIndex].y},i={x:s[e.lastIndex].x-s[e.middleIndex].x,y:s[e.lastIndex].y-s[e.middleIndex].y};return n.x*i.y-i.x*n.y>0}function St(s,t){s===0&&(s=t);const e=s+1;return{beginIndex:s-1,middleIndex:s,lastIndex:e>t?1:e}}function et(s,t){const[e,n]=s,i=n.x-e.x,o=n.y-e.y;let r=((t.x-e.x)*i+(t.y-e.y)*o)/(i*i+o*o);r=Math.min(1,Math.max(0,r));const l=B(e.x,n.x,r),a=B(e.y,n.y,r);return{x:l,y:a}}function B(s,t,e){return s+e*(t-s)}function V(s,t){const[e,n]=s,i=n.x-e.x,o=n.y-e.y;let r=((t.x-e.x)*i+(t.y-e.y)*o)/(i*i+o*o);if(r<0||r>1)return null;const l=B(e.x,n.x,r),a=B(e.y,n.y,r);return{x:l,y:a}}function nt(s){return!isNaN(parseFloat(s))&&isFinite(s)}class Ct{constructor(t){this.sheet=t,this.room=null,this.curWall=null,this.prevPos=null,y.on(x.SET_THICKNESS,this.setThickness.bind(this))}atach(t){this.room=t,this.calcRoomPolygon(),this.createRoomWalls();const e=this.sheet.canvas;e.addEventListener("pointerdown",this.onPointerDown.bind(this)),e.addEventListener("pointermove",this.onPointerMove.bind(this)),e.addEventListener("pointerup",this.onPointerUp.bind(this))}deatach(){this.room=null}calcRoomPolygon(){tt(this.room.points)?(this.room.outPolygon=R(this.room.points,this.room.thickness),this.room.innerPolygon=R(this.room.points,-this.room.thickness)):(this.room.outPolygon=R(this.room.points,-this.room.thickness),this.room.innerPolygon=R(this.room.points,this.room.thickness))}createRoomWalls(){const t=this.room.outPolygon.length;for(let e=0;e<t;e++){const n=new $;n.axis=[this.room.points[e],this.room.points[(e+1)%t]],n.points=[this.room.outPolygon[e],this.room.outPolygon[(e+1)%t],this.room.innerPolygon[(e+1)%t],this.room.innerPolygon[e]],this.room.walls.push(n)}}updateWallPoints(){const t=this.room.outPolygon.length,e=this.room.walls;for(let n=0;n<e.length;n++){const i=e[n];i.points=[this.room.outPolygon[n],this.room.outPolygon[(n+1)%t],this.room.innerPolygon[(n+1)%t],this.room.innerPolygon[n]]}}onPointerDown(t){const e=this.sheet.getPointerPos(t),n=this.getWallUnderPointer(e);n&&(this.curWall=n,m.move(),this.prevPos=e)}onPointerMove(t){const e=this.sheet.getPointerPos(t);this.curWall?(this.dragWall(e),y.emit(x.REDRAW_CANVAS),this.prevPos=e):this.getWallUnderPointer(e)?m.pointer():m.auto()}onPointerUp(){this.curWall&&(this.curWall=null,m.auto())}dragWall(t){const[e,n]=this.curWall.axis,i=Wt(e,n),o=P({x:0,y:0},i);if(!nt(o))return;const r=et(this.curWall.axis,t);if(r.x===e.x&&r.y===e.y||r.x===n.x&&r.y===n.y){this.curWall=null;return}let l=A(this.prevPos,t);const a=Math.sign(t.x-r.x),h=Math.sign(t.y-r.y),c=new g(Math.abs(Math.cos(o)*l)*a,Math.abs(Math.sin(o)*l)*h);this.curWall.axis.forEach(d=>d.add(c)),this.curWall.points.forEach(d=>d.add(c)),this.calcRoomPolygon(),this.updateWallPoints()}getWallUnderPointer(t){const e=this.room.walls;for(let n=0;n<e.length;n++){const i=e[n];if(T(t,i.points))return i}return!1}setThickness(t){this.room.thickness=t,this.calcRoomPolygon(),this.updateWallPoints(),y.emit(x.REDRAW_CANVAS)}}class st{constructor(){this.vertices=new Map,this.edgeList=new Map,this.face=[]}}class Rt{constructor(){this.id="",this.projectId="",this.name="",this.vertices=new Map,this.walls=new Map,this.edgeList=new Map,this.face=[],this.axisOfFloor=new st,this.wallOfFloor=null,this.outerPolygons=[],this.innerPolygons=[]}}class It{constructor(t,e){this.p1=t||new g(0,0),this.p2=e||new g(0,0)}}class u{constructor(t,e,n){this.id=n||0,this.x=t||0,this.y=e||0,this.incidentEdges=new Set,this.parents=[]}setPos(t,e){t&&e?(this.x=t,this.y=e):t&&(this.x=t.x,this.y=t.y)}setIncidentEdge(t){this.incidentEdges.add(t)}copy(){return new u(this.x,this.y)}addBelonging(t){this.belongTo.push(t)}removeBelonging(t){}}function W(s,t){const e=t.x-s.x,n=t.y-s.y,i=Math.sqrt(e*e+n*n);return new u(-n/i,e/i)}function M(s,t,e){const n=t.x*e,i=t.y*e;return new It(new u(s[0].x+n,s[0].y+i),new u(s[1].x+n,s[1].y+i))}function it(s,t){const e=W(s[0],s[1]),n=M(s,e,t),i=new u(-e.x,-e.y),o=M(s,i,t);return[n.p1,n.p2,o.p2,o.p1]}function ot(s){let t=0;const e=s.length;for(let n=0;n<s.length;++n){const i=s[n],o=(n+1)%e,r=s[o];t+=i.x*r.y-i.y*r.x}return Math.abs(t/2)}function bt(s){let t=0,e=0,n,i=0,o,r;for(var l=s.length-1;l>=0;i=l--)o=s[l],r=s[i],n=o.x*r.y-r.x*o.y,t+=(o.x+r.x)*n,e+=(o.y+r.y)*n;return n=ot(s)*6,{x:t/n,y:e/n}}class Tt{constructor(t){this.data=t,this.pattern=K()}draw(t){this.drawFloor(t);for(let e of this.data.walls.values())this.drawAxis(t,e.axis[0],e.axis[1])}drawFloor(t){if(this.data.outerPolygons.length<=0&&this.data.innerPolygons.length<=0)return;const e=this.data.outerPolygons[0].vertices;t.strokeStyle="black";const n=new Path2D;this.drawPolygon(n,e),t.font="16px serif",this.data.innerPolygons.forEach(o=>{this.drawPolygon(n,o.vertices);const r=bt(o.vertices);r&&t.strokeText((o.area/1e4).toFixed(2),r.x-8,r.y-8)}),t.stroke(n);const i=t.createPattern(this.pattern,"repeat");t.fillStyle=i,t.fill(n,"evenodd")}drawWall(t,e){const n=it(e.axis,e.thiсkness/2);t.strokeStyle="black";const i=new Path2D;this.drawPolygon(i,n),t.stroke(i);const o=t.createPattern(this.pattern,"repeat");t.fillStyle=o,t.fill(i,"evenodd")}drawAxis(t,e,n){t.strokeStyle="gray",t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(n.x,n.y),t.closePath(),t.stroke(),t.fillStyle="gray",t.beginPath(),t.moveTo(e.x,e.y),t.arc(e.x,e.y,4,0,Math.PI*2,!0),t.moveTo(n.x,n.y),t.arc(n.x,n.y,4,0,Math.PI*2,!0),t.fill()}drawPolygon(t,e){if(e.length===0)return;const n=e[0];t.moveTo(n.x,n.y);for(let i=1;i<e.length;i++){let o=e[i];t.lineTo(o.x,o.y)}t.closePath()}}function D(s,t,e){return e=e||1,Math.abs(s.x-t.x)<=e&&Math.abs(s.y-t.y)<=e}class k{constructor(t){this.name=t,this.origin=null,this.twin=null,this.incidentFace=null,this.next=null,this.prev=null,this.angle=0,this.wall=null}}function rt(s,t,e){const n=s.p1,i=s.p2,o=t.p1,r=t.p2,l=(r.y-o.y)*(i.x-n.x)-(r.x-o.x)*(i.y-n.y);if(l===0)return null;const a=((r.x-o.x)*(n.y-o.y)-(r.y-o.y)*(n.x-o.x))/l;if(e){const d=((i.x-n.x)*(n.y-o.y)-(i.y-n.y)*(n.x-o.x))/l;if(a<0||a>1||d<0||d>1)return null}const h=n.x+a*(i.x-n.x),c=n.y+a*(i.y-n.y);return new u(h,c)}const J=Math.PI*2;function O(s,t){t.set(s.id,s)}function Bt(s,t,e){const[n,i]=s.axis,{vertices:o,edgeList:r}=t,l=lt(n,i,r);l.edge1.wall=s,l.edge2.wall=s;for(let a=0;a<s.axis.length;a++){const h=s.axis[a],c=ht(h,r,5);if(c.targetEdge){const d=b(h,c.targetEdge,r);d.edge1.wall=c.targetEdge.wall,d.edge2.wall=c.targetEdge.wall,h.parents.push(c.targetEdge.wall),c.targetEdge.wall.childs.push(h),S(h,r),O(h,o)}else N(h,o,r)}}function kt(s,t){const[e,n]=s.axis,{vertices:i,edgeList:o}=t;for(let a=0;a<s.axis.length;a++){const h=s.axis[a];let c=j(h,i,o);if(c){s.axis[a]=c;return}if(c=ht(h,o,10),c.targetEdge){const d=b(h,c.targetEdge,o);d.edge1.wall=c.targetEdge.wall,d.edge2.wall=c.targetEdge.wall,h.parents.push(c.targetEdge.wall),c.targetEdge.wall.childs.push(h),S(h,o)}}const r=o.get(`${e.id}-${n.id}`),l=Ut(r,o);if(l){const a=new u(l.point.x,l.point.y,p());a.parents.push(l.edge1,l.edge2),l.edge1.wall.childs.push(a),l.edge2.wall.childs.push(a);let h=b(a,r,o);h.edge1.wall=r.wall,h.edge2.wall=r.wall,h=b(a,l.edge2,o),h.edge1.wall=l.edge2.wall,h.edge2.wall=l.edge2.wall,S(a,o),O(a,i),console.dir(t)}}function b(s,t,e){const n=t,i=t.twin,o=n.origin,r=i.origin,l=new k(`${s.id}-${o.id}`),a=new k(`${s.id}-${r.id}`);return l.origin=s,a.origin=s,s.setIncidentEdge(l.name),s.setIncidentEdge(a.name),l.twin=n,a.twin=i,n.twin=l,i.twin=a,l.next=i.next,a.next=n.next,e.set(l.name,l),e.set(a.name,a),{edge1:l,edge2:a}}function U(s,t,e){lt(s,t,e.edgeList),N(s,e.vertices,e.edgeList),N(t,e.vertices,e.edgeList)}function lt(s,t,e){const n=new k(`${s.id}-${t.id}`),i=new k(`${t.id}-${s.id}`);return n.origin=s,i.origin=t,s.setIncidentEdge(n.name),t.setIncidentEdge(i.name),n.twin=i,i.twin=n,e.set(n.name,n),e.set(i.name,i),{edge1:n,edge2:i}}function N(s,t,e){t.has(s.id)?S(s,e):(t.set(s.id,s),j(s,t,e))}function Ot(s,t,e){t.incidentEdges.forEach(n=>{e.get(n).origin=s,s.incidentEdges.add(n)}),S(s,e)}function j(s,t,e){let n=at(s,t);if(n)return Ot(n,s,e),t.delete(s.id),n}function at(s,t){for(let e of t.values())if(s.id!==e.id&&D(s,e))return e;return null}function S(s,t){if(s.incidentEdges.size<=1)return;const e=Array.from(s.incidentEdges,i=>t.get(i));e.forEach(i=>i.angle=(J+P(i.origin,i.twin.origin))%J),e.sort((i,o)=>i.angle>o.angle?-1:1);const n=e.length;for(let i=0;i<n;i++){const o=e[i],r=e[(i-1+n)%n].twin;o.prev=r,r.next=o;const l=e[(i+1)%n];o.twin.next=l,l.prev=o.twin}}function ht(s,t,e){const n=new Set;let i=null,o=null;for(let r of t.values()){if(r.origin.id===s.id||r.twin.origin.id===s.id||n.has(r))continue;n.add(r),n.add(r.twin);const l=V([r.origin,r.twin.origin],s);if(!l)continue;A(s,l)<e&&(i=r,o=l)}return{targetEdge:i,closestPoint:o}}function Ut(s,t){const e={p1:s.origin,p2:s.twin.origin},n=new Set;for(let i of t.values()){if(s.name===i.name||s.twin.name===i.name||n.has(i.twin.name)||Nt(s,i))continue;const o={p1:i.origin,p2:i.twin.origin},r=rt(e,o,!0);if(r)return{point:r,edge1:s,edge2:i};n.add(i.name)}}function Nt(s,t){return s.origin.id===t.origin.id||s.origin.id===t.twin.origin.id||s.twin.origin.id===t.origin.id||s.twin.origin.id===t.twin.origin.id}class Ft{constructor(t){this.vertices=t||[],this.area=0,this.role=""}}class Vt{constructor(t){this.data=t}getUniqVertex(t){for(let[e,n]of this.data.axisOfFloor.vertices)if(D(t,n))return n;return t}addUniqVertex(t){const e=at(t,this.data.axisOfFloor.vertices);return e||(O(t,this.data.axisOfFloor),this.data.vertices.set(t.id,t),t)}addVertex(t){O(t,this.data.axisOfFloor)}addWall(t){return this.data.walls.set(t.id,t),Bt(t,this.data.axisOfFloor,this.data.walls),t}checkingAfterAddedWall(t){const{vertices:e,edgeList:n}=this.data.axisOfFloor;kt(t,this.data.axisOfFloor),t.axis.forEach(i=>{j(i,e,n)})}getVertices(){return this.data.vertices}identifyPolygons(){const{vertices:t,edgeList:e}=this.data.wallOfFloor,n=new Set,i=[];for(;n.size<t.size;){const o=new Ft,l=this.getUnusedVertex(n,t).incidentEdges.values().next().value,a=e.get(l);this.next(a,n,o),o.vertices.length&&(o.area=ot(o.vertices),i.push(o))}i.sort((o,r)=>o.area-r.area),this.data.outerPolygons=[],this.data.outerPolygons.push(i.pop()),this.data.innerPolygons=i}next(t,e,n){e.add(t.origin.id),n.vertices.push(t.origin);const i=t.next;e.has(i.origin.id)||this.next(i,e,n)}getUnusedVertex(t,e){return t.size===0?e.values().next().value:Array.from(e.values()).find(n=>!t.has(n.id))}}class Dt{constructor(t){this.project=new Pt(1,"test"),this.sheet=t,this.roomEditor=new Ct(this.sheet),this.currentFloor=null,this.addListeners()}addListeners(){y.on(x.CREATE_ROOM,this.createRoom.bind(this)),y.on(x.SET_READY,this.setSketchReady.bind(this))}getProject(){return this.project}getActualFloor(){if(!this.currentFloor){const t=new Rt;this.sheet.add(new Tt(t)),this.currentFloor=new Vt(t)}return this.currentFloor}getRoom(){return this.project.rooms[0]}createRoom(t){const e=new pt(t||"blank");this.project.rooms.push(e);const n=new Et(e);this.sheet.add(n)}setSketchReady(){this.project.rooms[0].ready=!0,this.roomEditor.atach(this.project.rooms[0])}getRoomByName(t){return this.project.rooms.find(e=>{if(e.name===t)return!0})}}function jt(s,t,e,n){let i=s.x*(t.y-e.y)+t.x*(e.y-s.y)+e.x*(s.y-t.y);return i=Math.abs(i)<n?0:i,!Math.floor(i)}const Q=[0,Math.PI*.25,Math.PI*.5,Math.PI*.75,Math.PI],q=.06,I=8;class zt{constructor(t){this.points=[],this.projectManager=t}snapToAngle(t,e,n){for(let i=0;i<Q.length;i++){const o=Q[i],r=Math.sign(t),l=Math.abs(t)-o;if(l<q&&l>-q){const a=Math.abs(A(e,n)),h=Math.cos(o*r),c=Math.sin(o*r),d=a*h+e.x,f=a*c+e.y;return{x:d,y:f}}}return!1}snapToPoint(t,e,n){const i=n.vertices;for(let o of i.values())if(!(e&&o.id===e.id)&&o.x<t.x+I&&o.x>t.x-I&&o.y<t.y+I&&o.y>t.y-I)return t.x=o.x,t.y=o.y,new u(o.x,o.y);return null}snapToLine(t,e,n){let i=null;for(let o=0;o<e.length;o++){const r=e[o];if(jt(t,r.p1,r.p2,n||10)){i=r;break}}i&&console.log(i)}snapToAxis(t,e,n){let i=null;const o=e.length;let r=null;for(let l=0;l<o;l++){const a=e[l],h=V(a,t);if(!h)continue;A(t,h)<n&&(r=a,i=h)}return{targetLine:r,closestPoint:i}}}function Yt(s,t,e){const n=new g(t.x-s.x,t.y-s.y),i=new g(e.x-s.x,e.y-s.y),o=n.x*i.x+n.y*i.y,r=Math.sqrt(n.x*n.x+n.y*n.y),l=Math.sqrt(i.x*i.x+i.y*i.y),a=o/(r*l);return Math.acos(a)}const ct=Math.PI,E=ct/2;class Jt{constructor(t){this.projectManager=t,this.sheet=t.sheet,this.img=new Image,this.img.src="data:image/png;base64, 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",this.imgX=0,this.imgY=0,this.imgAngle=0,this.img.addEventListener("load",()=>{this.imgWidth=this.img.naturalWidth,this.imgHeight=this.img.naturalHeight,this.imgHalfDiagonal=Math.sqrt(Math.pow(this.imgWidth/2,2)+Math.pow(this.imgHeight/2,2)),this.imgX=this.imgWidth/2,this.imgY=this.imgHeight/2}),this.offsetX=0,this.offsetY=0,this.date=null,this.cursorIsPointer=!1,y.on(x.SET_READY,this.startUsing.bind(this)),this.bind(),this.closestPoint=null,this.nearestAdjacentLnes=null,this.adjacentClosestPoint=null,this.localPoint=null}bind(){this.onPointerDown=this.onPointerDown.bind(this),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerUp=this.onPointerUp.bind(this)}startUsing(){const t=this.sheet.canvas;t.addEventListener("pointerdown",this.onPointerDown),t.addEventListener("pointermove",this.onPointerMove),t.addEventListener("pointerup",this.onPointerUp),this.sheet.add(this)}onPointerDown(t){const e=this.sheet.getPointerPos(t);this.hitImage(e)&&(this.isDraggable=!0,this.offsetX=e.x-this.imgX,this.offsetY=e.y-this.imgY,m.move())}onPointerMove(t){const e=this.sheet.getPointerPos(t);if(this.isDraggable){const n=this.projectManager.getRoom().innerPolygon,i=this.projectManager.getRoom().outPolygon;this.overShape=T(e,i),this.overShape&&(this.data=this.getClosestLine(e,n)),this.data&&this.data.minDisttance<this.imgWidth/1.8?(this.imgAngle=P(n[this.data.index],n[(this.data.index+1)%n.length]),this.getAngSofa(this.data,n),this.getNewPos(this.data,n)):(this.imgX=e.x,this.imgY=e.y,this.imgAngle=0),y.emit(x.REDRAW_CANVAS)}else this.hitImage(e)?(m.pointer(),this.cursorIsPointer=!0):this.cursorIsPointer&&(m.auto(),this.cursorIsPointer=!1)}getNewPos(t,e){const n=this.imgHeight/2;let i=t.closestPoint.x+(n+1)*Math.cos(this.imgAngle+E),o=t.closestPoint.y+(n+1)*Math.sin(this.imgAngle+E);this.closestPoint=t.closestPoint,this.nearestAdjacentLnes=null,this.imgX=i,this.imgY=o;const r=this.getClosestLine({x:i,y:o},e,t.index);if(this.adjacentClosestPoint=r.closestPoint,this.nearestAdjacentLnes=[e[r.index],e[(r.index+1)%e.length]],this.isPointOut(e)){const l=this.getPointsNeighboringLines(t.index,r.index,e),a=Yt(...l),h=P(l[0],l[1]),c=Math.cos(h),d=Math.sin(h);if(a<E){const f=Math.sin(E-a)/Math.sin(a)*this.imgHeight;t.closestPoint.x=l[0].x+c*(f+this.imgWidth/2),t.closestPoint.y=l[0].y+d*(f+this.imgWidth/2)}else t.closestPoint.x=l[0].x+c*this.imgWidth/2,t.closestPoint.y=l[0].y+d*this.imgWidth/2;i=t.closestPoint.x+(n+1)*Math.cos(this.imgAngle+E),o=t.closestPoint.y+(n+1)*Math.sin(this.imgAngle+E)}this.imgX=i,this.imgY=o}getPointsNeighboringLines(t,e,n){return t===0&&e===n.length-1?[n[t],n[t+1],n[e]]:e===0&&t===n.length-1?[n[e],n[t],n[e+1]]:t<e?[n[e],n[t],n[(e+1)%n.length]]:t>e?[n[t],n[(t+1)%n.length],n[e]]:[n[t],n[(t+1)%n.length],n[t-1]]}getAngSofa(t,e){const{index:n,closestPoint:i,minDisttance:o,pointerPos:r}=t,l=P(e[n],e[(n+1)%e.length]);P(i,r),this.imgAngle=l,tt(e)?this.imgAngle=l:this.imgAngle=l-ct}isPointOut(t){const e=this.getVertexImage();console.log(e);for(let n=0;n<e.length;n++){const i=e[n];if(!T(i,t))return!0}}onPointerUp(t){this.isDraggable&&(this.isDraggable=!1)}draw(t){this.imgAngle?(this.drawImageCenter(t,this.img,this.imgX,this.imgY,this.imgWidth/2,this.imgHeight/2,1,this.imgAngle),t.setTransform(1,0,0,1,0,0)):t.drawImage(this.img,this.imgX-this.imgWidth/2,this.imgY-this.imgHeight/2),this.closestPoint&&(t.strokeStyle="red",t.beginPath(),t.moveTo(this.closestPoint.x,this.closestPoint.y),t.arc(this.closestPoint.x,this.closestPoint.y,2,0,Math.PI*2,!0),t.stroke())}drawImageCenter(t,e,n,i,o,r,l,a){t.setTransform(l,0,0,l,n,i),t.rotate(a),t.drawImage(e,-o,-r)}hitImage(t){const e=new g(t.x-this.imgX,t.y-this.imgY);e.rotateAround(this.imgAngle);const n=this.imgWidth/2,i=this.imgHeight/2;return e.x>-n&&e.x<n&&e.y>-i&&e.y<i}getClosestLine(t,e,n){let i=0,o=null,r=1e5,l=1e5;const a=e.length;for(let h=0;h<a;h++){if(n!==void 0&&h===n)continue;const c=e[h],d=e[(h+1)%a],f=et([c,d],t),w=A(t,f);w<r&&(r=w,i=h,o=f,l=w)}return{index:i,closestPoint:o,minDisttance:l,pointerPos:t}}getVertexImage(){const t=this.imgWidth/2,e=this.imgHeight/2,n=new g(this.imgX,this.imgY);let i={tl:new g(-t,-e),tr:new g(t,-e),bl:new g(-t,e),br:new g(t,e)};return this.imgAngle===0?[i.tl.add(n),i.tr.add(n),i.bl.add(n),i.br.add(n)]:[i.tl.rotateAround(this.imgAngle).add(n),i.tr.rotateAround(this.imgAngle).add(n),i.bl.rotateAround(this.imgAngle).add(n),i.br.rotateAround(this.imgAngle).add(n)]}}function Qt(s,t,e,n,i,o,r,l){s.setTransform(r,0,0,r,e,n),s.rotate(l),s.drawImage(t,-i,-o)}class qt{constructor(t){const e=document.createElement("canvas"),n=e.getContext("2d");e.width=t*2+2||6,e.height=t*2+2||6,n.fillStyle="#999",n.arc(t+1,t+1,t,0,Math.PI*2,!0),n.fill(),n.strokeStyle="#333",n.lineWidth=1,n.stroke(),this.img=new Image,this.img.src=e.toDataURL("image/png"),this.imgWidth=t,this.imgHeight=t,this.pos=new g(this.imgWidth/2,this.imgHeight/2),this.offset=new g(this.imgWidth/2,this.imgHeight/2),this.img.addEventListener("load",()=>{this.imgWidth=this.img.naturalWidth,this.imgHeight=this.img.naturalHeight,this.imgHalfDiagonal=Math.sqrt(Math.pow(this.imgWidth/2,2)+Math.pow(this.imgHeight/2,2)),this.pos.set(this.imgWidth/2,this.imgHeight/2)})}setPos(t){this.pos.x=t.x,this.pos.y=t.y}draw(t){Qt(t,this.img,this.pos.x,this.pos.y,this.imgWidth/2,this.imgHeight/2,1,this.imgAngle),t.setTransform(1,0,0,1,0,0)}}function Xt(s,t){let e=t.x-s.x,n=t.y-s.y;const i=e*e+n*n,o=Math.sqrt(i);return n=n/o,e=e/o,new g(e,n)}const v=10;function dt(s){const t=new st;console.log(s.axisOfFloor);const e={edgeList:s.axisOfFloor.edgeList,usedEdges:new Set,firstVertex:null,parallel:null,lastVertex:null};for(;e.usedEdges.size<e.edgeList.size;)e.firstVertex=null,e.lastVertex=null,e.parallel=null,z(Kt(e),e,t);s.wallOfFloor=t}function Kt(s){return s.usedEdges.size===0?s.edgeList.values().next().value:Array.from(s.edgeList.values()).find(t=>!s.usedEdges.has(t.name))}function z(s,t,e){t.usedEdges.has(s.name)||(s.next?Ht(s,t,e):Zt(s,t,e))}function Ht(s,t,e){const n=s.origin,i=s.twin.origin,o=t.parallel||M([n,i],W(n,i),v),r=s.next.twin.origin,l=M([i,r],W(i,r),v);let a=rt(o,l);a===null&&(a=new u(l.p1.x,l.p1.y)),a.id=p(),t.usedEdges.has(s.next.name)&&t.firstVertex.setPos(a),t.lastVertex===null&&(t.lastVertex=new u(o.p1.x,o.p1.y,p())),U(t.lastVertex,a,e),t.usedEdges.add(s.name),t.firstVertex===null&&(t.firstVertex=t.lastVertex),t.parallel=l,t.lastVertex=a,z(s.next,t,e)}function Zt(s,t,e){const n=s.origin,i=s.twin.origin,o=Xt(n,i),r=new u(i.x+o.x*v,i.y+o.y*v),l=W(n,r),a=M([n,r],l,v),h=a.p2;t.lastVertex===null&&(t.lastVertex=new u(a.p1.x,a.p1.y,p())),h.id=p(),t.usedEdges.add(s.name),U(t.lastVertex,h,e);const c=new u(-l.x,-l.y),d=M([n,r],c,v),f=d.p2;f.id=p(),t.usedEdges.has(s.twin.name)&&t.firstVertex.setPos(f),U(h,f,e),t.firstVertex===null&&(t.firstVertex=t.lastVertex),t.parallel=d,t.lastVertex=f,z(s.twin,t,e)}class Gt{constructor(t,e){this.sheet=t,this.alignmentSnapper=e,this.cursor=new qt(4),this.floor=null,this.drawnWall=null,this.correctedPos=null,this.wallHasLength=!1,this.bind()}bind(){this.onPointerDown=this.onPointerDown.bind(this),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerUp=this.onPointerUp.bind(this)}atach(t){this.floor=t;const e=this.sheet.canvas;e.addEventListener("pointerdown",this.onPointerDown),e.addEventListener("pointermove",this.onPointerMove),e.addEventListener("pointerup",this.onPointerUp),this.sheet.add(this.cursor),m.none()}detach(){const t=this.sheet.canvas;t.removeEventListener("pointerdown",this.onPointerDown),t.removeEventListener("pointermove",this.onPointerMove),t.removeEventListener("pointerup",this.onPointerUp),this.sheet.remove(this.cursor),m.auto(),this.floor=null,y.emit(x.REDRAW_CANVAS)}onPointerDown(t){this.drawnWall=new $;const e=this.correctedPos||this.sheet.getPointerPos(t);let n=new u(e.x,e.y);n=this.floor.getUniqVertex(n),n.id||(n.id=p());let i=new u(n.x,n.y,p());this.drawnWall.axis.push(n),this.drawnWall.axis.push(i)}onPointerMove(t){var o;const e=this.sheet.getPointerPos(t);this.correctedPos=null,this.targetLine=null;let n;if(this.drawnWall){const[r,l]=this.drawnWall.axis,a=P(r,e);this.correctedPos=this.alignmentSnapper.snapToAngle(a,r,e),n=l;const h=D(r,l,10);this.wallHasLength===!1&&h===!1&&(this.floor.addWall(this.drawnWall),this.wallHasLength=!0),this.wallHasLength}if(this.floor.data.walls.size){const r=Array.from(this.floor.data.walls,a=>a[1].axis),l=this.alignmentSnapper.snapToAxis(e,r,6);l.closestPoint&&(this.correctedPos=l.closestPoint),l.targetLine&&(this.targetLine=l.targetLine)}const i=this.alignmentSnapper.snapToPoint(new u(e.x,e.y),n,this.floor.data.axisOfFloor);i&&(this.correctedPos=i),(o=this.drawnWall)==null||o.axis[1].setPos(this.correctedPos||e),this.cursor.setPos(this.correctedPos||e),y.emit(x.REDRAW_CANVAS)}onPointerUp(){this.drawnWall&&(this.floor.checkingAfterAddedWall(this.drawnWall),this.drawnWall=null,this.wallHasLength=!1,dt(this.floor.data),this.floor.identifyPolygons())}}class _t{constructor(t){this.floor=null,this.floorData=null,this.walls=[],this.sheet=t,this.canvas=null,this.bind()}bind(){this.onPointerDown=this.onPointerDown.bind(this),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerUp=this.onPointerUp.bind(this)}atach(t){this.floor=t,this.floorData=t.data,this.sheet.canvas.addEventListener("pointerdown",this.onPointerDown),this.sheet.canvas.addEventListener("pointermove",this.onPointerMove),this.sheet.canvas.addEventListener("pointerup",this.onPointerUp),this.createWallsPolygon()}detach(){this.floor=null,this.floorData=null,this.sheet.canvas.removeEventListener("pointerdown",this.onPointerDown),this.sheet.canvas.removeEventListener("pointermove",this.onPointerMove),this.sheet.canvas.removeEventListener("pointerup",this.onPointerUp)}onPointerDown(t){const e=this.sheet.getPointerPos(t),n=this.getWallUnderPointer(e);n&&(this.curWall=n,m.move(),this.prevPos=e)}onPointerMove(t){const e=this.sheet.getPointerPos(t);this.curWall?(this.dragWall(e),this.prevPos=e):this.getWallUnderPointer(e)?m.move():m.auto()}onPointerUp(){this.curWall&&(this.curWall=null,m.auto())}dragWall(t){const[e,n]=this.curWall.wall.axis,i=W(e,n),o=P({x:0,y:0},i);if(!nt(o))return;const r=V(this.curWall.wall.axis,t);if(r===null){this.curWall=null;return}let l=A(r,t);const a=Math.sign(t.x-r.x),h=Math.sign(t.y-r.y),c=new u(Math.abs(Math.cos(o)*l)*a,Math.abs(Math.sin(o)*l)*h);this.curWall.wall.axis.forEach(d=>d.setPos(d.x+=c.x,d.y+=c.y)),this.curWall.rect.forEach(d=>d.setPos(d.x+=c.x,d.y+=c.y)),this.curWall.wall.childs.forEach(d=>d.setPos(d.x+=c.x,d.y+=c.y)),dt(this.floor.data),this.floor.identifyPolygons(),y.emit(x.REDRAW_CANVAS)}getWallUnderPointer(t){for(let e=0;e<this.walls.length;e++){const n=this.walls[e].rect;if(T(t,n))return this.walls[e]}return!1}createWallsPolygon(){this.floorData.walls.forEach(t=>{const e=it(t.axis,10);this.walls.push({rect:e,wall:t})})}}const L={NONE:"none",WALL_CREATOR:"WallCreator",WALL_MOVER:"WallMover"};class $t{constructor(t,e){this.sheet=t,this.alignmentSnapper=new zt(e),this.projectManager=e,this.wallCreator=null,this.wallMover=null,this.activeTool=L.NONE,this.addListeners()}addListeners(){y.on(X.CREATE_WALL,this.createWall.bind(this))}createWall(){this.wallCreator===null&&(this.wallCreator=new Gt(this.sheet,this.alignmentSnapper)),this.activeTool===L.WALL_CREATOR?(this.wallCreator.detach(),this.wallMover===null&&(this.wallMover=new _t(this.sheet)),this.wallMover.atach(this.projectManager.getActualFloor()),this.activeTool=L.WALL_MOVER):(this.activeTool===L.WALL_MOVER&&this.wallMover.detach(),this.activeTool=L.WALL_CREATOR,this.wallCreator.atach(this.projectManager.getActualFloor()))}}class te{constructor(){this.startDrawBtn=new xt,this.sheet=new mt,this.projectManager=new Dt(this.sheet),this.toolsManager=new $t(this.sheet,this.projectManager),this.sofa=new Jt(this.projectManager),wt()}}window.addEventListener("load",()=>{new te});
